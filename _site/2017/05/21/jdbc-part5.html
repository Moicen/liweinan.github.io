<p>In database design, there are usually three levels of transaction support: No transaction, Local transaction, Distributed transaction.</p>

<p>No-transaction means each SQL command will be executed and their effects will be persisted into the database immediately. In PostgreSQL database, this is supported by setting <code class="highlighter-rouge">autocommit</code> option to <code class="highlighter-rouge">true</code>, and users are not issuing the <code class="highlighter-rouge">BEGIN</code> command to start a transaction explicitly. In this situation, we can see each SQL command being in their own transaction.</p>

<p>Local-transaction means the users will explicitly start a transaction by using the <code class="highlighter-rouge">BEGIN</code> command, and then the following SQL commands are in one transaction, until a <code class="highlighter-rouge">COMMIT</code> command is met, and all the effects of the commands will be persisted into database at once, or fail as a whole.</p>

<p>Distributed-transaction means the database will participate in a bigger transaction out of the database system scope itself. For example, we may have a transaction that includes several participants, which are: two databases, one EJB session bean, one webservice, etc. In this situation, our database is just one of the participants of the whole transaction.</p>

<p>There are several specifications in distribution transaction area, and the most popular one is <code class="highlighter-rouge">X/Open XA</code> spec, and it’s adopted by the JDBC spec. You can see relative interfaces in JDBC library, such as the<code class="highlighter-rouge">XADataSource</code> interface. In PostgreSQL JDBC driver, you can see the classes that implements these interfaces. We will check the details on distributed transactions in another article.</p>

<p>In this article, I will focus on the No-transaction and the Local-transaction situation to see how doesn the PostgreSQL driver to support them. I want to check the <code class="highlighter-rouge">setAutoCommit(...)</code> method defined in <code class="highlighter-rouge">java.sql.Connection</code> interface to see how it affects the transaction processing in underlying database system.</p>

<p>Now let’s use the PostgreSQL JDBC driver to write an example to execute some SQL commands, and check how does the driver implements the JDBC interface. Firstly, I need to open the SQL logging capability of the PostgreSQL. I have installed my <code class="highlighter-rouge">postgresql</code> database by Homebrew(See <a href="https://brew.sh/">https://brew.sh/</a>) on my MacOS machine, and the configuration file is located at <code class="highlighter-rouge">/usr/local/pgsql/data/postgresql.conf</code>.</p>

<p>Here is what I have changed in configuration file:</p>

<div class="language-diff highlighter-rouge"><pre class="highlight"><code><span class="gd">--- postgresql.conf.orig    2017-05-03 23:23:53.000000000 +0800
</span><span class="gi">+++ postgresql.conf 2017-05-03 23:11:48.000000000 +0800
</span><span class="gu">@@ -333,18 +333,22 @@
</span>                    # depending on platform.  csvlog
                    # requires logging_collector to be on.
 
<span class="gi">+log_destination = stderr
+
</span> # This is used when logging to stderr:
 #logging_collector = off       # Enable capturing of stderr and csvlog
                    # into log files. Required to be on for
                    # csvlogs.
                    # (change requires restart)
 
<span class="gi">+logging_collector = on
+
</span> # These are only used if logging_collector is on:
<span class="gd">-#log_directory = 'pg_log'      # directory where log files are written,
</span><span class="gi">+log_directory = 'pg_log'       # directory where log files are written,
</span>                    # can be absolute or relative to PGDATA
<span class="gd">-#log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'   # log file name pattern,
</span><span class="gi">+log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'    # log file name pattern,
</span>                    # can include strftime() escapes
<span class="gd">-#log_file_mode = 0600          # creation mode for log files,
</span><span class="gi">+log_file_mode = 0600           # creation mode for log files,
</span>                    # begin with 0 to use octal notation
 #log_truncate_on_rotation = off        # If on, an existing log file with the
                    # same name as the new log file will be
<span class="gu">@@ -354,9 +358,9 @@
</span>                    # or size-driven rotation.  Default is
                    # off, meaning append to existing files
                    # in all cases.
<span class="gd">-#log_rotation_age = 1d         # Automatic rotation of logfiles will
</span><span class="gi">+log_rotation_age = 1d          # Automatic rotation of logfiles will
</span>                    # happen after that time.  0 disables.
<span class="gd">-#log_rotation_size = 10MB      # Automatic rotation of logfiles will
</span><span class="gi">+log_rotation_size = 10MB       # Automatic rotation of logfiles will
</span>                    # happen after that much log output.
                    # 0 disables.
 
<span class="gu">@@ -451,6 +455,7 @@
</span>                    # e.g. '&lt;%u%%%d&gt; '
 #log_lock_waits = off          # log lock waits &gt;= deadlock_timeout
 #log_statement = 'none'            # none, ddl, mod, all
<span class="gi">+log_statement = 'all'
</span> #log_replication_commands = off
 #log_temp_files = -1           # log temporary files equal or larger
                    # than the specified size in kilobytes;
</code></pre>
</div>

<p>With the above changes, the <code class="highlighter-rouge">postgresql</code> server will log the SQL statements executed by clients. If your database server has been started, then you need to restart the server after the configuration file is changed.</p>

<p>After the database server is restarted, we can check the JDBC driver side now. Let’s write a sample class in Java to demonstrate the usage of the JDBC driver. Here is the code:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.postgresql.util.PSQLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.postgresql.util.PSQLState</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.DriverManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Statement</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Properties</span><span class="o">;</span>

<span class="cm">/**
 * Created by weli on 30/04/2017.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectConnection</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"org.postgresql.Driver"</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"jdbc:postgresql://localhost/weli"</span><span class="o">;</span>
        <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
        <span class="n">props</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="s">"weli"</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"ssl"</span><span class="o">,</span> <span class="s">"false"</span><span class="o">);</span>

        <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">props</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
            <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s">"insert into user_info (id, name, age) values (10, 'weli', 16);"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PSQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getSQLState</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">PSQLState</span><span class="o">.</span><span class="na">NO_DATA</span><span class="o">.</span><span class="na">getState</span><span class="o">()))</span> <span class="o">{</span>
                <span class="c1">// expected</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// conn.commit();</span>
             <span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The above code will connect to my local database server, and run a <code class="highlighter-rouge">insert</code> SQL command to add an entry of data into the database. The important line is this:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</code></pre>
</div>

<p>The above line of code will put the database into the <code class="highlighter-rouge">autocommit</code> mode. Please note we have commented out the <code class="highlighter-rouge">commit()</code> method of the connection in <code class="highlighter-rouge">finally</code> block. This is because in autocommit mode, the <code class="highlighter-rouge">executeQuery(...)</code> method of the statement will be implicitly included into its own transaction.</p>

<p>Now we can compile the above class with PostgreSQL JDBC driver in class path:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>javac -cp ~/.m2/repository/org/postgresql/postgresql/42.0.1-SNAPSHOT/postgresql-42.0.1-SNAPSHOT.jar DirectConnection.java
</code></pre>
</div>

<p>After the compilation is done, we can run the class like this:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>java -cp ~/.m2/repository/org/postgresql/postgresql/42.0.1-SNAPSHOT/postgresql-42.0.1-SNAPSHOT.jar:. DirectConnection
</code></pre>
</div>

<p>After the above command finished running, we can check the SQL log provided by database server:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span><span class="nb">pwd</span>
/usr/local/pgsql/data/pg_log
<span class="gp">$ </span>tail -f postgresql-2017-05-22_000000.log
...
STATEMENT:  insert into user_info <span class="o">(</span>id, name, age<span class="o">)</span> values <span class="o">(</span>10, <span class="s1">'weli'</span>, 16<span class="o">)</span>
</code></pre>
</div>

<p>From the above log, we can see the JDBC statement maps to a single SQL command, and there are no <code class="highlighter-rouge">BEGIN</code> or <code class="highlighter-rouge">COMMIT</code> commands surrounded the statement. In this way, we can see how does database deal with the implicit transaction: every single SQL command is treated as an atomic operation and will be persisted into database immediately.</p>

<p>Now let’s go back to the class file and this time we will set the <code class="highlighter-rouge">autoCommit</code> property to <code class="highlighter-rouge">false</code>:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</code></pre>
</div>

<p>After setting the auto commit property to <code class="highlighter-rouge">false</code>, we need to explicitly set commit the transaction in <code class="highlighter-rouge">final</code> block. Here is the code:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">conn</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</code></pre>
</div>

<p>Now we recompile the class and rerun the class, and here is the output of the SQL log:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nl">LOG:</span>  <span class="n">execute</span> <span class="o">&lt;</span><span class="n">unnamed</span><span class="o">&gt;:</span> <span class="n">BEGIN</span>
<span class="nl">LOG:</span>  <span class="n">execute</span> <span class="o">&lt;</span><span class="n">unnamed</span><span class="o">&gt;:</span> <span class="n">insert</span> <span class="n">into</span> <span class="nf">user_info</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">)</span> <span class="n">values</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="err">'</span><span class="n">weli</span><span class="err">'</span><span class="o">,</span> <span class="mi">16</span><span class="o">)</span>
<span class="nl">LOG:</span>  <span class="n">execute</span> <span class="nl">S_1:</span> <span class="n">COMMIT</span>
</code></pre>
</div>

<p>From the above log, we can see this time there are <code class="highlighter-rouge">BEGIN</code> and <code class="highlighter-rouge">COMMIT</code> commands surrounded the statement. We can see the effect of the <code class="highlighter-rouge">autoCommit</code> property in JDBC: when it’s setting to <code class="highlighter-rouge">false</code>, then the JDBC driver will add a <code class="highlighter-rouge">BEGIN</code> command before the statement, and then users need to explicitly commit the transaction with <code class="highlighter-rouge">commit()</code> method.</p>

<p>The relative implementation is in the <code class="highlighter-rouge">org.postgresql.jdbc.PgStatement</code> class. The <code class="highlighter-rouge">autoCommit</code> property will be used to set flags in <code class="highlighter-rouge">executeInternal(..., int flags)</code> method of <code class="highlighter-rouge">org.postgresql.jdbc.PgStatement</code> class. Here is the relative code in the method:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">connection</span><span class="o">.</span><span class="na">getAutoCommit</span><span class="o">())</span> <span class="o">{</span>
  <span class="n">flags</span> <span class="o">|=</span> <span class="n">QueryExecutor</span><span class="o">.</span><span class="na">QUERY_SUPPRESS_BEGIN</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

<p>From above code, we can see the <code class="highlighter-rouge">QueryExecutor.QUERY_SUPPRESS_BEGIN</code> value is added into flags. Here is the definition of <code class="highlighter-rouge">QUERY_SUPPRESS_BEGIN</code> in <code class="highlighter-rouge">org.postgresql.core.QueryExecutor.QUERY_SUPPRESS_BEGIN</code> class:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Flag for query execution that indicates the automatic BEGIN on the first statement when outside
 * a transaction should not be done.
 */</span>
<span class="kt">int</span> <span class="n">QUERY_SUPPRESS_BEGIN</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>
</code></pre>
</div>

<p>After the flags is set, it will finally affect the <code class="highlighter-rouge">sendQueryPreamble(...)</code> method in <code class="highlighter-rouge">org.postgresql.core.v3.QueryExecutorImpl</code> class. Here is the code of the method:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="n">ResultHandler</span> <span class="nf">sendQueryPreamble</span><span class="o">(</span><span class="kd">final</span> <span class="n">ResultHandler</span> <span class="n">delegateHandler</span><span class="o">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">)</span>
     <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
   <span class="c1">// First, send CloseStatements for finalized SimpleQueries that had statement names assigned.</span>
   <span class="n">processDeadParsedQueries</span><span class="o">();</span>
   <span class="n">processDeadPortals</span><span class="o">();</span>

   <span class="c1">// Send BEGIN on first statement in transaction.</span>
   <span class="k">if</span> <span class="o">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QueryExecutor</span><span class="o">.</span><span class="na">QUERY_SUPPRESS_BEGIN</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span>
       <span class="o">||</span> <span class="n">getTransactionState</span><span class="o">()</span> <span class="o">!=</span> <span class="n">TransactionState</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">return</span> <span class="n">delegateHandler</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="kt">int</span> <span class="n">beginFlags</span> <span class="o">=</span> <span class="n">QueryExecutor</span><span class="o">.</span><span class="na">QUERY_NO_METADATA</span><span class="o">;</span>
   <span class="k">if</span> <span class="o">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QueryExecutor</span><span class="o">.</span><span class="na">QUERY_ONESHOT</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">beginFlags</span> <span class="o">|=</span> <span class="n">QueryExecutor</span><span class="o">.</span><span class="na">QUERY_ONESHOT</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="n">beginFlags</span> <span class="o">|=</span> <span class="n">QueryExecutor</span><span class="o">.</span><span class="na">QUERY_EXECUTE_AS_SIMPLE</span><span class="o">;</span>

   <span class="n">beginFlags</span> <span class="o">=</span> <span class="n">updateQueryMode</span><span class="o">(</span><span class="n">beginFlags</span><span class="o">);</span>

   <span class="n">sendOneQuery</span><span class="o">(</span><span class="n">beginTransactionQuery</span><span class="o">,</span> <span class="n">SimpleQuery</span><span class="o">.</span><span class="na">NO_PARAMETERS</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">beginFlags</span><span class="o">);</span>

   <span class="c1">// Insert a handler that intercepts the BEGIN.</span>
   <span class="k">return</span> <span class="k">new</span> <span class="nf">ResultHandlerDelegate</span><span class="o">(</span><span class="n">delegateHandler</span><span class="o">)</span> <span class="o">{</span>
     <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">sawBegin</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleResultRows</span><span class="o">(</span><span class="n">Query</span> <span class="n">fromQuery</span><span class="o">,</span> <span class="n">Field</span><span class="o">[]</span> <span class="n">fields</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[][]&gt;</span> <span class="n">tuples</span><span class="o">,</span>
         <span class="n">ResultCursor</span> <span class="n">cursor</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">sawBegin</span><span class="o">)</span> <span class="o">{</span>
         <span class="kd">super</span><span class="o">.</span><span class="na">handleResultRows</span><span class="o">(</span><span class="n">fromQuery</span><span class="o">,</span> <span class="n">fields</span><span class="o">,</span> <span class="n">tuples</span><span class="o">,</span> <span class="n">cursor</span><span class="o">);</span>
       <span class="o">}</span>
     <span class="o">}</span>

     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleCommandStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">status</span><span class="o">,</span> <span class="kt">int</span> <span class="n">updateCount</span><span class="o">,</span> <span class="kt">long</span> <span class="n">insertOID</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">if</span> <span class="o">(!</span><span class="n">sawBegin</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">sawBegin</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
         <span class="k">if</span> <span class="o">(!</span><span class="n">status</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"BEGIN"</span><span class="o">))</span> <span class="o">{</span>
           <span class="n">handleError</span><span class="o">(</span><span class="k">new</span> <span class="n">PSQLException</span><span class="o">(</span><span class="n">GT</span><span class="o">.</span><span class="na">tr</span><span class="o">(</span><span class="s">"Expected command status BEGIN, got {0}."</span><span class="o">,</span> <span class="n">status</span><span class="o">),</span>
               <span class="n">PSQLState</span><span class="o">.</span><span class="na">PROTOCOL_VIOLATION</span><span class="o">));</span>
         <span class="o">}</span>
       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
         <span class="kd">super</span><span class="o">.</span><span class="na">handleCommandStatus</span><span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="n">updateCount</span><span class="o">,</span> <span class="n">insertOID</span><span class="o">);</span>
       <span class="o">}</span>
     <span class="o">}</span>
   <span class="o">};</span>
 <span class="o">}</span>
</code></pre>
</div>

<p>In above code, if <code class="highlighter-rouge">QueryExecutor.QUERY_SUPPRESS_BEGIN</code> is set in flag, then it will return immediately. The relative code is here:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// Send BEGIN on first statement in transaction.</span>
<span class="k">if</span> <span class="o">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">QueryExecutor</span><span class="o">.</span><span class="na">QUERY_SUPPRESS_BEGIN</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="o">||</span> <span class="n">getTransactionState</span><span class="o">()</span> <span class="o">!=</span> <span class="n">TransactionState</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">delegateHandler</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">QueryExecutor.QUERY_SUPPRESS_BEGIN</code> is set by default, unless <code class="highlighter-rouge">autoCommit</code> is set to false in <code class="highlighter-rouge">java.sql.Connection</code>. If <code class="highlighter-rouge">QueryExecutor.QUERY_SUPPRESS_BEGIN</code> is unset, which means <code class="highlighter-rouge">autoCommit</code> is set to false in <code class="highlighter-rouge">java.sql.Connection</code> by the user, then the rest part of the code in <code class="highlighter-rouge">sendQueryPreamble(...)</code> method will be executed, and a <code class="highlighter-rouge">BEGIN</code> command will be sent to database server. Here is the relative code:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">sendOneQuery</span><span class="o">(</span><span class="n">beginTransactionQuery</span><span class="o">,</span> <span class="n">SimpleQuery</span><span class="o">.</span><span class="na">NO_PARAMETERS</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">beginFlags</span><span class="o">);</span>
<span class="n">The</span> <span class="n">above</span> <span class="n">code</span> <span class="n">will</span> <span class="n">send</span> <span class="n">a</span> <span class="n">beginTransactionQuery</span> <span class="n">to</span> <span class="n">the</span> <span class="n">database</span> <span class="n">server</span><span class="o">.</span> <span class="n">We</span> <span class="n">can</span> <span class="n">see</span> <span class="n">the</span> <span class="n">definition</span> <span class="n">of</span> <span class="n">beginTransactionQuery</span> <span class="n">in</span> <span class="n">org</span><span class="o">.</span><span class="na">postgresql</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">v3</span><span class="o">.</span><span class="na">QueryExecutorImpl</span> <span class="n">itself</span><span class="o">.</span> <span class="n">Here</span> <span class="n">is</span> <span class="n">the</span> <span class="nl">definition:</span>

<span class="kd">private</span> <span class="kd">final</span> <span class="n">SimpleQuery</span> <span class="n">beginTransactionQuery</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">SimpleQuery</span><span class="o">(</span>
          <span class="k">new</span> <span class="nf">NativeQuery</span><span class="o">(</span><span class="s">"BEGIN"</span><span class="o">,</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="kc">false</span><span class="o">,</span> <span class="n">SqlCommand</span><span class="o">.</span><span class="na">BLANK</span><span class="o">),</span>
          <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</code></pre>
</div>

<p>From the above definition, we can see the <code class="highlighter-rouge">beginTransactionQuery</code> represents the <code class="highlighter-rouge">BEGIN</code> command in database server.</p>

<p>What if we commit the transaction when <code class="highlighter-rouge">autoCommit</code> is <code class="highlighter-rouge">true</code>? Let’s change our sample class file like this:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="k">try</span> <span class="o">{</span>
       <span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
       <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
       <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="s">"insert into user_info (id, name, age) values (10, 'weli', 16);"</span><span class="o">);</span>
   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PSQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getSQLState</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">PSQLState</span><span class="o">.</span><span class="na">NO_DATA</span><span class="o">.</span><span class="na">getState</span><span class="o">()))</span> <span class="o">{</span>
           <span class="c1">// expected</span>
       <span class="o">}</span>
   <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
       <span class="n">conn</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
       <span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
   <span class="o">}</span>
</code></pre>
</div>

<p>The above code set the auto commit mode to <code class="highlighter-rouge">true</code>, and then the connection will call the <code class="highlighter-rouge">commit()</code> method finally. Let’s recompile the class and run it, and here is the output:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>java -cp ~/.m2/repository/org/postgresql/postgresql/42.0.1-SNAPSHOT/postgresql-42.0.1-SNAPSHOT.jar:. DirectConnection
Exception <span class="k">in </span>thread <span class="s2">"main"</span> org.postgresql.util.PSQLException: Cannot commit when autoCommit is enabled.
	at org.postgresql.jdbc.PgConnection.commit<span class="o">(</span>PgConnection.java:755<span class="o">)</span>
	at DirectConnection.main<span class="o">(</span>DirectConnection.java:36<span class="o">)</span>
</code></pre>
</div>

<p>From the above code, we can see an error is thrown, and the message says it cannot commit when autoCommit is enabled. This is reasonable, because when <code class="highlighter-rouge">autoCommit</code> is set to <code class="highlighter-rouge">true</code>, then the JDBC driver won’t send <code class="highlighter-rouge">BEGIN</code> command to the server, and it’s meaningless to send a <code class="highlighter-rouge">COMMIT</code> command by <code class="highlighter-rouge">commit()</code> method.</p>

<p>This behavior is defined in <code class="highlighter-rouge">org.postgresql.jdbc.PgConnection</code> class:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">commit</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
   <span class="n">checkClosed</span><span class="o">();</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">autoCommit</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">throw</span> <span class="k">new</span> <span class="nf">PSQLException</span><span class="o">(</span><span class="n">GT</span><span class="o">.</span><span class="na">tr</span><span class="o">(</span><span class="s">"Cannot commit when autoCommit is enabled."</span><span class="o">),</span>
         <span class="n">PSQLState</span><span class="o">.</span><span class="na">NO_ACTIVE_SQL_TRANSACTION</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">queryExecutor</span><span class="o">.</span><span class="na">getTransactionState</span><span class="o">()</span> <span class="o">!=</span> <span class="n">TransactionState</span><span class="o">.</span><span class="na">IDLE</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">executeTransactionCommand</span><span class="o">(</span><span class="n">commitQuery</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>From the above code, we can see the <code class="highlighter-rouge">autoCommit</code> flag will be checked in <code class="highlighter-rouge">commit()</code> method.</p>

